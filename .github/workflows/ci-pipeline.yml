name: Dev pipeline

on:
  pull_request:
  workflow_dispatch:

jobs:
  static-code-analysis:
    name: Static Code Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Static Code Analysis
        run: echo "Running static code analysis..."

  generate-matrix:
    name: Generate apps matrix
    runs-on: ubuntu-latest
    needs: static-code-analysis
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Find app folders under apps/
        id: set-matrix
        run: |
          mapfile -t FOLDERS < <(find apps -maxdepth 1 -mindepth 1 -type d -printf '%f\n')
          # create objects for matrix
          J="["
          SEP=""
          for folder in "${FOLDERS[@]}"; do
            J="${J}${SEP}{\"app\":\"$folder\"}"
            SEP=","
          done
          J="${J}]"
          MATRIX="{\"include\":$J}"
          echo "Detected app folders: $J"
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  provisioning-linode:
    name: Provisioning Linode [${{ matrix.app }}]
    runs-on: ubuntu-latest
    needs: generate-matrix
    strategy:
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
      max-parallel: 2
    outputs:
      linode-info: ${{ steps.provision.outputs.linode-info }}
    steps:
      - name: Provision Linode for ${{ matrix.app }}
        id: provision
        run: |
          echo "Provisioning Linode for app: ${{ matrix.app }}"
          echo "linode-info=Linode details for ${{ matrix.app }}" >> $GITHUB_OUTPUT

  deploy-application:
    name: Deploy Application [${{ matrix.app }}]
    runs-on: ubuntu-latest
    needs: [ generate-matrix, provisioning-linode ]
    strategy:
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
      max-parallel: 2
    steps:
      - name: Deploy Application for ${{ matrix.app }}
        run: |
          echo "Deploying application for app: ${{ matrix.app }}"
          echo "Using Linode info: ${{ needs.provisioning-linode.outputs.linode-info }}"

  run-tests:
    name: Run Tests [${{ matrix.app }}]
    runs-on: ubuntu-latest
    needs: [ generate-matrix, deploy-application ]
    strategy:
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
      max-parallel: 2
    steps:
      - name: Run Tests for ${{ matrix.app }}
        run: |
          echo "Running tests for app: ${{ matrix.app }}"
          echo "Using app info: ${{ needs.deploy-application.outputs.app-info }}"

  delete-linode:
    name: Delete Linode [${{ matrix.app }}]
    runs-on: ubuntu-latest
    needs: [generate-matrix, run-tests]
    strategy:
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
      max-parallel: 2
    steps:
      - name: Delete Linode for ${{ matrix.app }}
        run: |
          echo "Deleting Linode for app: ${{ matrix.app }}"

  notify-results:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: delete-linode
    steps:
      - name: Notify Results
        run: echo "Notifying results of the CI pipeline..."