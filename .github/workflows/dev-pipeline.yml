name: Dev pipeline

on:
  pull_request:

permissions:
  pull-requests: write
  issues: write

jobs:
  static-code-analysis:
    name: running static code analysis
    runs-on: ubuntu-latest
    steps:
      - name: Static Code Analysis
        run: echo "Running static code analysis..."

  get-changes-from-pr:
    name: getting changes from pr
    runs-on: ubuntu-latest
    needs: static-code-analysis
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find changed app folders in PR
        id: set-matrix
        run: |
          # Get the list of changed files in the PR
          CHANGED_FILES=$(git diff --name-only origin/main)
      
          # Filter for app directories under apps/
          APPS=$(echo "$CHANGED_FILES" | grep '^apps/' | cut -d'/' -f2 | sort -u)
      
          # Create objects for matrix
          if [ -z "$APPS" ]; then
            MATRIX="{\"include\":[]}"
          else
            J="["
            SEP=""
            for app in $APPS; do
              J="${J}${SEP}{\"app\":\"$app\"}"
              SEP=","
            done
            J="${J}]"
            MATRIX="{\"include\":$J}"
          fi
      
          echo "Detected changed app folders: $MATRIX"
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  combined-job:
    name: testing ${{ matrix.app }}
    runs-on: ubuntu-latest
    needs: get-changes-from-pr
    strategy:
      matrix: ${{ fromJson(needs.get-changes-from-pr.outputs.matrix) }}
      max-parallel: 2
    steps:
      - name: running tests for ${{ matrix.app }} app
        run: |
          set -e
          pip install selenium webdriver-manager
          ls
          python3 apps/${{ matrix.app }}/app_tests.py ${{ steps.provision.outputs.linode-info }}

  notify-results:
    name: providing results
    runs-on: ubuntu-latest
    needs: combined-job
    if: always()
    steps:
      - name: post workflow results
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const status = '${{ needs.combined-job.result }}';
            const runUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            github.rest.issues.createComment({
              owner: pr.base.repo.owner.login,
              repo: pr.base.repo.name,
              issue_number: pr.number,
              body: `Hello @${pr.user.login},\n\nThe CI workflow for your PR #${pr.number} has completed.\nStatus: **${status}**\n\n[View workflow run details](${runUrl})`
            });
