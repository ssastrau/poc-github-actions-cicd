name: Dev pipeline

on:
  pull_request:

jobs:
  static-code-analysis:
    name: 1. Static Code Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Static Code Analysis
        run: echo "Running static code analysis..."

  get-list-of-apps:
    name: 2. Get list of apps
    runs-on: ubuntu-latest
    needs: static-code-analysis
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find changed app folders in PR
        id: set-matrix
        run: |
          # Get the list of changed files in the PR
          CHANGED_FILES=$(git diff --name-only origin/main)
      
          # Filter for app directories under apps/
          APPS=$(echo "$CHANGED_FILES" | grep '^apps/' | cut -d'/' -f2 | sort -u)
      
          # Create objects for matrix
          if [ -z "$APPS" ]; then
            MATRIX="{\"include\":[]}"
          else
            J="["
            SEP=""
            for app in $APPS; do
              J="${J}${SEP}{\"app\":\"$app\"}"
              SEP=","
            done
            J="${J}]"
            MATRIX="{\"include\":$J}"
          fi
      
          echo "Detected changed app folders: $MATRIX"
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  combined-job:
    name: 3. ${{ matrix.app }}
    runs-on: ubuntu-latest
    needs: get-list-of-apps
    strategy:
      matrix: ${{ fromJson(needs.get-list-of-apps.outputs.matrix) }}
      max-parallel: 2
    steps:
      - name: Provision Linode for ${{ matrix.app }}
        id: provision
        run: |
          set -e
          RESPONSE=$(curl -s -o response.json -w "%{http_code}" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.LINODE_API_SECRET }}" \
            -X POST -d '{
                "image": "linode/ubuntu22.04",
                "maintenance_policy": "linode/migrate",
                "private_ip": false,
                "region": "se-sto",
                "type": "g6-nanode-1",
                "label": "ubuntu-se-sto",
                "root_pass": "${{ secrets.LINODE_ROOT_PASS }}",
                "disk_encryption": "enabled"
            }' https://api.linode.com/v4/linode/instances)
          
          if [ "$RESPONSE" -ne 200 ]; then
            echo "API call failed with status code $RESPONSE"
            cat response.json
            exit 1
          fi
          
          IPV4=$(jq -r '.ipv4[0]' response.json)
          echo "linode-info=$IPV4" >> $GITHUB_OUTPUT

      - name: Deploy Application for ${{ matrix.app }}
        id: deploy
        run: |
          set -e
          LINODE_ID=$(jq -r '.id' response.json)
          LINODE_IPV4=$(jq -r '.ipv4[0]' response.json)
          
          # Wait for Linode to be fully provisioned
          TIMEOUT=300
          ELAPSED=0
          while true; do
            STATUS=$(curl -s -H "Authorization: Bearer ${{ secrets.LINODE_API_SECRET }}" \
              https://api.linode.com/v4/linode/instances/$LINODE_ID | jq -r '.status')
            if [ "$STATUS" == "running" ]; then
              break
            fi
            if [ "$ELAPSED" -ge "$TIMEOUT" ]; then
              echo "Timeout reached. Linode provisioning failed."
              exit 1
            fi
            echo "Waiting for Linode to be provisioned..."
            sleep 10
            ELAPSED=$((ELAPSED + 10))
          done
          
          # Retry SSH connection
          SSH_TIMEOUT=300
          SSH_ELAPSED=0
          while true; do
            if sshpass -p "${{ secrets.LINODE_ROOT_PASS }}" ssh -o StrictHostKeyChecking=no root@$LINODE_IPV4 "exit"; then
              break
            fi
            if [ "$SSH_ELAPSED" -ge "$SSH_TIMEOUT" ]; then
              echo "Timeout reached. Unable to connect to Linode via SSH."
              exit 1
            fi
            echo "Waiting for SSH to be ready..."
            sleep 10
            SSH_ELAPSED=$((SSH_ELAPSED + 10))
          done
          
          # Clone the repository, run test-vars.sh, and then run the installation script
          sshpass -p "${{ secrets.LINODE_ROOT_PASS }}" ssh -o StrictHostKeyChecking=no root@$LINODE_IPV4 "
          set -e
          git clone --depth 1 --branch ${{ github.head_ref }} ${{ github.event.pull_request.head.repo.clone_url }} /root/repo &&
          cd /root/repo/apps/${{ matrix.app }} &&
          chmod +x test-vars.sh deployment_script.sh &&
          . ./test-vars.sh &&
          ./deployment_script.sh
          "

      - name: Run Jenkins UI Test for ${{ matrix.app }}
        run: |
          set -e
          pip install selenium webdriver-manager
          python3 apps/${{ matrix.app }}/app_tests.py ${{ steps.provision.outputs.linode-info }}

      - name: Delete Linode for ${{ matrix.app }}
        if: always()
        run: |
          set -e
          LINODE_ID=$(jq -r '.id' response.json)
          if [ -n "$LINODE_ID" ] && [ "$LINODE_ID" != "null" ]; then
            curl -s -X DELETE \
              -H "Authorization: Bearer ${{ secrets.LINODE_API_SECRET }}" \
              https://api.linode.com/v4/linode/instances/$LINODE_ID
            echo "Linode $LINODE_ID deleted."
          else
            echo "No Linode ID found to delete."
          fi

  notify-results:
    name: 4. Notify Results
    runs-on: ubuntu-latest
    needs: combined-job
    if: always()
    steps:
      - name: Post workflow result as PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const status = '${{ needs.combined-job.result }}';
            const runUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            github.rest.issues.createComment({
              owner: pr.base.repo.owner.login,
              repo: pr.base.repo.name,
              issue_number: pr.number,
              body: `Hello @${pr.user.login},\n\nThe CI workflow for your PR #${pr.number} has completed.\nStatus: **${status}**\n\n[View workflow run details](${runUrl})`
            });
